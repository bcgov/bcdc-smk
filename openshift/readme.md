# BCDC SMK

Contains the code that is used to deploy a base site for SMK.  This is a very
simple base SMK site that is then referenced via an iframe by package pages
in presented by the catalog.

This repo is primarily in existence as a base site for the code that is 
deployed via github actions.

## CD/CI Pipeline

### Build (.github/workflows/build.yaml)
* Triggered by 'open' pull request
* creates a tag
* tags the PR issue with the image tag
* creates the docker image and uploads to github packages


### Deploy to Dev (.github/workflows/devdeploy.yaml)
* Triggered by the completion of the build workflow
* Logs into openshift (dev), using the secrets
    * OPENSHIFT_SERVER_URL
    * OPENSHIFT_TOKEN_DEV
* deletes route / service / deployment
* runs the template with the new image tag to deploy new image
* Adds the route that is generated by the deploy to the PR issue

### Deploy to Prd (.github/workflows/prddeploy.yaml)
* Triggered by the PR being closed and merged
* Logs into openshift  (prd), using the secrets
    * OPENSHIFT_SERVER_URL
    * OPENSHIFT_TOKEN_PRD
* Deploys the service / route / deployment to prod using 'oc process' on template piped into 'oc replace"
* deletes the service / route / deployment in dev oc env


# Trouble shooting

### deploy a new image using its label
`oc process -f https://raw.githubusercontent.com/bcgov/bcdc-smk/dev/openshift/deployTemplate.yaml  -p ENV=dev -p IMAGE_LABEL=20200821-1547 | oc replace -n dbc-kirk-tools -f -`

### deploy template using local file reference
`oc process -f ./openshift/deployTemplate.yaml -p ENV=dev -p IMAGE_LABEL=20200821-1547 | oc replace -n dbc-kirk-tools -f -`

### delete everything defined in template
```
DEPLOY_NAMESPACE=dbc-kirk-tools
oc process -f ./openshift/deployTemplate.yaml --param-file .env.prd | oc create -n $DEPLOY_NAMESPACE -f - 
```


# Misc Info used to figure out actions / CD/CI pipeline

## links for sharing data between steps/jobs/workflows:
   * https://stackoverflow.com/questions/58675200/in-github-actions-can-i-return-back-a-value-to-be-used-as-a-condition-later
   * https://github.com/marketplace/actions/persist-data-between-jobs
   * https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idneeds

# Misc other links used to figure out workflow
* [github actions openshift package](https://github.com/redhat-developer/openshift-actions)
* [example of template with service account and role](https://github.com/bcgov/repomountie/blob/master/openshift/templates/cicd.yaml)
* [openshift cheat sheet](https://design.jboss.org/redhatdeveloper/marketing/openshift_cheatsheet/cheatsheet/images/openshift_cheat_sheet_r1v1.pdf)
* [RBAC documentation](https://docs.openshift.com/container-platform/3.11/admin_guide/manage_rbac.html#creating-local-role)
* [openshift authorization docs - anchor goes to roles](https://docs.openshift.com/container-platform/3.11/architecture/additional_concepts/authorization.html#roles)
* [info on creating roles](https://docs.openshift.com/container-platform/3.11/admin_guide/manage_rbac.html#viewing-local-roles-and-bindings)
* [example deploy pipeline used for ckan](https://gogs.data.gov.bc.ca/bcdc/deployment/src/branch/master/ocp/.openshift/bcdc-ckan-ext-cicd.yaml)





